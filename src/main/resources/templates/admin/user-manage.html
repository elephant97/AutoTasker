<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default}"> <!--thymeleaf 적용-->
<head>
    <meta charset="UTF-8">
    <title>admin-page</title>
    <link rel="stylesheet"  th:href="@{/css/styles.css}">
    <meta charset="utf-8">
<!--bootstrap 적용-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

</head>

<body>

<div class="container">
    <h2>User Manager</h2>
    <table class="table table-hover">
        <thead>
        <tr>
            <th>아이디</th>
            <th>이 름</th>
            <th>이메일</th>
            <th>SVN ID</th>
            <th>부 서</th>
            <th>승인 여부</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${userList}" data-toggle="modal" data-target="#userEditModal">
            <td th:text="${user.userId}" ></td>
            <td th:text="${user.userName}"></td>
            <td th:text="${user.userEmail}"></td>
            <td th:text="${user.svnId}"></td>
            <td th:text="${user.department}"></td>
            <td th:style="${user.status == 'N'} ? 'color: red;' : 'color: green;'">
                <span th:text="${user.status}"></span>
            </td>
            <!-- 승인 상태가 "N"인 경우에만 승인 버튼을 추가합니다 -->
            <td th:if="${user.status == 'N'}">
                <div class="button-container" style="display: block;">
                    <!--승인-->
                    <form th:action="@{/admin/approve-user}" th:object="${user}" method="post" style="float:left; margin: 2px;">
                        <input type="hidden" th:name="userNo" th:value="${user.userNo}" />
                        <button style="background-color: lawngreen; color: black;" type="submit"
                                class="approve-button" th:user-name="${user.userName}" th:do-action="approve"
                                onclick="return confirmAction(this.getAttribute('do-action'), this.getAttribute('user-name'))">승인</button>
                    </form>
                    <!--거절-->
                    <form th:action="@{/admin/delete-user}" th:object="${user}" method="post" style="float:left; margin: 2px;">
                        <input type="hidden" th:name="userNo" th:value="${user.userNo}" />
                        <button style="background-color: red; color: black;" type="submit"
                                class="reject-button"  th:user-name="${user.userName}" th:do-action="delete"
                                onclick="return confirmAction(this.getAttribute('do-action'), this.getAttribute('user-name'))">거절</button>
                    </form>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <nav style="text-align: center; ">
        <ul class="pagination" style="display: inline-block;">
            <li th:if="${userList.hasPrevious()}" style="float: left;" >
                <a th:href="@{'/admin?page=' + ${userList.previousPageable.pageNumber}}"><<     </a>
            </li>
            <li th:each="page : ${userList.pageable.pageNumber}" th:class="${page == userList.number} ? 'active' : ''" style="float: left;" >
                <a th:if="${page == userList.number}" th:text="${page + 1}"></a>
                <a th:unless="${page == userList.number}" th:href="@{'/admin?page=' + ${page}}" th:text="${page + 1}"></a>
            </li>
            <li th:if="${userList.hasNext()}" style="float: left;" >
                <a th:href="@{'/admin?page=' + ${userList.nextPageable.pageNumber}}">     >></a>
            </li>
        </ul>
    </nav>

    <div class="modal fade" id="userEditModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content" >
                <div class="modal-body" style="text-align:center">
                    <form th:action="edit-user">
                        <div class="table_area" style="height: 300px; margin-top: 10px; width: 300px;">
                            <label for="userId" class="input_label" style='display:inline-block; width:100px; text-align:right; margin-top: 11px; margin-right: 5px;'>ID</label>
                            <input type="text"  	id = "userId" disabled  style="width: 140px; font-size: small; padding-left: 5px; height: 22px;"/>
                            <label for="userPwd" class="input_label" style='display:inline-block; width:100px; text-align:right;margin-right: 5px;'>password</label>
                            <input type="text"  	id = "userPwd" style="width: 140px; font-size: small; padding-left: 5px; height: 22px;"/><br/>
                            <label for="userEmail" class="input_label" style='display:inline-block; width:100px; text-align:right; margin-top: 7px; margin-right: 5px;'>E-Mail</label>
                            <input type="text"  	id = "userEmail" style="width: 140px; font-size: small; padding-left: 5px; height: 22px;"/>
                            <label for="department" class="input_label" style='display:inline-block; width:100px; text-align:right; margin-right: 5px;'>부서</label>
                            <input type="text"  	id = "department" style="width: 140px; font-size: small; padding-left: 5px; height: 22px;"/><br/>
                            <label for="svnId" class="input_label" style='display:inline-block; width:100px; text-align:right; margin-top: 7px; margin-right: 5px;'>SVN ID</label>
                            <input type="text"  	id = "svnId" style="width: 140px; font-size: small; padding-left: 5px; height: 22px;"/><br/>
                            <div class="button-container" style="display: block; margin:auto; text-align:center;">
                                <button class="save-button" style="background-color: dodgerblue;" type="submit">save</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



</div>
</body>
<th:block layout:fragment="script">
    <script th:inline="javascript">
        var result=[[${result}]];//model로 전달 된 result 바인딩

        if (result != null) { //model로 전달 된 result값 받아서 alert 창에 띄움
            alert(result);
        }else
        {
            console.log('result값이 NULL 입니다.');
        }

        function confirmAction(action, name) {
            // var userName = "${user.userName}";
            console.log(action + name);
            var confirmationMessage = (action === 'delete') ? "유저 승인을 거절하시겠습니까?\n확인을 누르면 해당 유저는 삭제됩니다." : "유저를 승인하시겠습니까?";
            return confirm("\"" + name + "\"" + confirmationMessage);
        }

        // 모달 열기
        document.querySelectorAll('tr[data-toggle="modal"]').forEach(function (element) {
            element.addEventListener('click', function () {
                var userData = $(this).children(); // JSON 형태의 데이터
                // var user = JSON.parse(userData);
                // JavaScript로 데이터 설정td.eq(0).text()
                console.log("하이" + userData.eq(0).text());
                document.getElementById("userId").value = userData.eq(0).text();
                document.getElementById("userPwd").value = userData.eq(1).text();
                document.getElementById("userEmail").value = userData.eq(2).text();
                document.getElementById("department").value = userData.eq(4).text();
                document.getElementById("svnId").value = userData.eq(3).text();

                // 모달 창을 열기
                $("#userEditModal").modal("show");
            });
        });


        // 모달 닫기
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("close")) {
                var modal = e.target.closest(".modal");
                modal.style.display = "none";
            }
        });
    </script>
</th:block>
</html>